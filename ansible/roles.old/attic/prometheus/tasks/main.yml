- name: deploy /etc/prometheus/prometheus.yml
  copy:
    dest: /etc/prometheus/prometheus.yml
    mode: 0644
    content: |
      global:
        scrape_interval:     1m
        evaluation_interval: 1m

      alerting:
        alertmanagers:
          - static_configs:
            - targets:
              - localhost:9093

      rule_files:
        # - "first_rules.yml"
        # - "second_rules.yml"

      scrape_configs:
        - job_name: 'prometheus'
          metrics_path: '/prometheus/metrics'
          static_configs:
            - targets: ['lenovo:9090']

        - job_name: 'node_exporter'
          static_configs:
            - targets:
              - 'lenovo:9111'
              - 'jonagold:9100'
              - 'ambrosia:9100'
              - 'net1:9100'
              - 'net2:9100'
              - 'qnap:9100'

        - job_name: 'grafana'
          static_configs:
            - targets: ['lenovo:3000']

        - job_name: 'unifi'
          static_configs:
            - targets: ['lenovo:9130']

        - job_name: 'pihole'
          static_configs:
            - targets: ['lenovo:9617']
            - targets: ['lenovo:9618']

        - job_name: 'sense'
          metrics_path: '/'
          static_configs:
            - targets: ['lenovo:10000']

        - job_name: ping
          metrics_path: /metrics
          static_configs:
            - targets: ['lenovo:9427']

        - job_name: speedtest
          metrics_path: /
          scrape_interval: 1h
          scrape_timeout: 1m
          static_configs:
            - targets: ['localhost:10101']

        - job_name: ambientweather
          metrics_path: /
          scrape_interval: 5m
          scrape_timeout: 1m
          static_configs:
            - targets: ['localhost:10102']

        - job_name: 'netdata-scrape'
          metrics_path: '/api/v1/allmetrics'
          params:
            # format: prometheus | prometheus_all_hosts
            # You can use `prometheus_all_hosts` if you want Prometheus to set the `instance` to your hostname instead of IP
            format: [prometheus_all_hosts]
            # sources: as-collected | raw | average | sum | volume
            # default is: average
            #source: [as-collected]
            # server name for this prometheus - the default is the client IP
            # for Netdata to uniquely identify it
            #server: ['prometheus1']
          honor_labels: true
          static_configs:
            - targets:
                - 'net1.cloudmason.org:19999'
                - 'net2.cloudmason.org:19999'
                - 'lenovo.cloudmason.org:19999'
                - 'jonagold.cloudmason.org:19999'
                - 'ambrosia.cloudmason.org:19999'

        - job_name: 'snmp'
          static_configs:
            - targets:
              - printer
          metrics_path: /snmp
          params:
            module: [if_mib]
          relabel_configs:
            - source_labels: [__address__]
              target_label: __param_target
            - source_labels: [__param_target]
              target_label: instance
            - target_label: __address__
              replacement: 127.0.0.1:9116

    backup: yes
  become: yes
  notify: restart prometheus
  tags: prometheus

- name: deploy /etc/prometheus/alertmanager.yml
  copy:
    dest: /etc/prometheus/alertmanager.yml
    mode: 0644
    content: |
      global:
        resolve_timeout: 5m

      route:
        group_by: ['alertname']
        group_wait: 10s
        group_interval: 10s
        repeat_interval: 1h
        receiver: 'web.hook'
      receivers:
      - name: 'web.hook'
        webhook_configs:
        - url: 'http://127.0.0.1:5001/'
      inhibit_rules:
        - source_match:
            severity: 'critical'
          target_match:
            severity: 'warning'
          equal: ['alertname', 'dev', 'instance']
    backup: yes
  become: yes
  notify: restart prometheus
  tags: prometheus
