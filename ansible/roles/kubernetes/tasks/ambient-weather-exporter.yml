---

- name: Create ambient-weather-exporter Secret
  community.kubernetes.k8s:
    state: present
    definition:
      apiVersion: v1
      data:
        AMBI_APP_KEY: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          37653432363135666237663564323830343363633166396636346366303031633933393438626532
          3438636465326263623435613437316362636231303339300a396331626634636335306238633062
          33656362633864386566653762383536383565643564383562373433353439376432396165353734
          6163643263646232300a313662613366636661623232333131373961663965613164373135383263
          61383432393932396366303333306436613833613631653462653137366466663939393537306532
          33366337653132626530656136316662356439623433653439363761353739343362316663396133
          32353166656131363033316562336562363232313835306131653036373064626165393863373931
          31303039623936663866363036636565613836323935333962613030313339623464383436613061
          3635
        AMBI_API_KEY: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          66373230333937663038306366386537353262343836623231336362303961393531323533333839
          3264653436363635343234396636366566356463613838320a623339623237353937363437383033
          63636163303066633066326330323937396163353866663533306430333239366639333332643530
          6661393965356333610a643032393837653763376331373739303732396635643039646130396335
          36333232346138316531653631336365643439376266363732633261393566323966343430353638
          36336438346564386531396462396563363634356662313130626138323532336234316363386339
          62393435636265356563373038623862373964306435366539653363343362306663633164616232
          39613533326334373061616534333830333735393531666330653361326463623335613936656138
          3561
      kind: Secret
      metadata:
        name: ambient-weather-exporter
        namespace: monitoring
      type: Opaque

- name: Create ambient-weather-exporter Deployment
  community.kubernetes.k8s:
    state: present
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: ambient-weather-exporter
        namespace: monitoring
      spec:
        replicas: 1
        selector:
          matchLabels:
            name: ambient-weather-exporter
        template:
          metadata:
            labels:
              name: ambient-weather-exporter
          spec:
            containers:
            - name: ambient-weather-exporter
              image: mamercad/ambient_weather_exporter
              env:
                - name: AMBI_APP_KEY
                  valueFrom:
                    secretKeyRef:
                      name: ambient-weather-exporter
                      key: AMBI_APP_KEY
                - name: AMBI_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: ambient-weather-exporter
                      key: AMBI_API_KEY

- name: Create ambient-weather-exporter Service
  community.kubernetes.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: ambient-weather-exporter-service
        namespace: monitoring
        labels:
          name: ambient-weather-exporter-service
      spec:
        type: ClusterIP
        selector:
          name: ambient-weather-exporter
        ports:
          - port: 10001
            targetPort: 10001
            name: ambient-weather-exporter-metrics

- name: Create ambient-weather-exporter ServiceMonitor
  community.kubernetes.k8s:
    state: present
    definition:
      apiVersion: monitoring.coreos.com/v1
      kind: ServiceMonitor
      metadata:
        name: ambient-weather-exporter
        namespace: monitoring
      spec:
        selector:
          matchLabels:
            name: ambient-weather-exporter-service
        endpoints:
          - port: ambient-weather-exporter-metrics
            path: /metrics/
            scrape_interval: 5m
            scrape_timeout: 1m
