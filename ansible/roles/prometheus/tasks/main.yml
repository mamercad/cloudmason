- name: deploy /etc/prometheus/prometheus.yml
  copy:
    dest: /etc/prometheus/prometheus.yml
    mode: 0644
    content: |
      global:
        scrape_interval:     1m
        evaluation_interval: 1m

      alerting:
        alertmanagers:
          - static_configs:
            - targets:
              - localhost:9093

      rule_files:
        # - "first_rules.yml"
        # - "second_rules.yml"

      scrape_configs:
        - job_name: 'prometheus'
          metrics_path: '/prometheus/metrics'
          static_configs:
            - targets: ['lenovo:9090']

        - job_name: 'node_exporter'
          static_configs:
            - targets:
              - 'lenovo:9111'
              - 'pihole:9100'
              - 'jonagold:9100'
              - 'openhab:9100'
              - 'ambrosia:9100'

        - job_name: 'grafana'
          static_configs:
            - targets: ['lenovo:3000']

        - job_name: 'unifi'
          static_configs:
            - targets: ['lenovo:9130']

        - job_name: 'pihole'
          static_configs:
            - targets: ['lenovo:9617']
            - targets: ['lenovo:9618']

        - job_name: 'sense'
          metrics_path: '/'
          static_configs:
            - targets: ['lenovo:10000']

        - job_name: ping
          metrics_path: /metrics
          static_configs:
            - targets: ['lenovo:9427']

        - job_name: speedtest
          metrics_path: /
          scrape_interval: 1h
          scrape_timeout: 1m
          static_configs:
            - targets: ['localhost:10101']
    backup: yes
  become: yes
  notify: restart prometheus

- name: deploy /etc/prometheus/alertmanager.yml
  copy:
    dest: /etc/prometheus/alertmanager.yml
    mode: 0644
    content: |
      global:
        resolve_timeout: 5m

      route:
        group_by: ['alertname']
        group_wait: 10s
        group_interval: 10s
        repeat_interval: 1h
        receiver: 'web.hook'
      receivers:
      - name: 'web.hook'
        webhook_configs:
        - url: 'http://127.0.0.1:5001/'
      inhibit_rules:
        - source_match:
            severity: 'critical'
          target_match:
            severity: 'warning'
          equal: ['alertname', 'dev', 'instance']
    backup: yes
  become: yes
  notify: restart prometheus
