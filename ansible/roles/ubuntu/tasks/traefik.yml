- name: Create the traefik group
  group:
    name: traefik
  become: yes

- name: Create the traefik user
  user:
    name: traefik
    group: traefik
    create_home: yes
    shell: /bin/bash
  become: yes

- name: Pull down the traefik binary tarball
  get_url:
    url: https://github.com/traefik/traefik/releases/download/v2.3.5/traefik_v2.3.5_linux_armv7.tar.gz
    checksum: sha256:853af73c985b32bcc17f7292b111ced0e93882362f819f1e3a65ef22f4fd5f51
    dest: /home/traefik/traefik_v2.3.5_linux_armv7.tar.gz
    owner: traefik
    group: traefik
    mode: 0644
  become: yes

- name: Extract the traefik tarball
  unarchive:
    src: /home/traefik/traefik_v2.3.5_linux_armv7.tar.gz
    dest: /home/traefik
    remote_src: yes
    owner: traefik
    group: traefik
    creates: /home/traefik/traefik
  become: yes

- name: Deploy traefik.toml
  copy:
    dest: /home/traefik/traefik.toml
    owner: traefik
    group: traefik
    mode: 0644
    content: |
      defaultEntryPoints = ["http", "https"]

      [entryPoints]
        [entryPoints.http]
          address = ":80"
          [entryPoints.http.http.redirections]
            [entryPoints.http.http.redirections.entryPoint]
              to = "https"
              scheme = "https"
        [entryPoints.https]
          address = ":443"

      [providers]
        [providers.file]
          filename = "/home/traefik/traefik_dynamic.toml"

      [certificatesResolvers.myresolver.acme]
        email = "{{ traefik.cloudflare.api_email }}"
        storage = "/home/traefik/acme.json"
        # caServer = "https://acme-staging-v02.api.letsencrypt.org/directory"
        caServer = "https://acme-v02.api.letsencrypt.org/directory"
        [certificatesResolvers.myresolver.acme.dnsChallenge]
          provider = "cloudflare"
          delayBeforeCheck = 0
          resolvers = ["1.1.1.1:53", "8.8.8.8:53"]
  notify: Restart traefik
  become: yes

- name: Deploy traefik_dynamic.toml
  copy:
    dest: /home/traefik/traefik_dynamic.toml
    owner: traefik
    group: traefik
    mode: 0644
    content: |
      [http]
        [http.routers]
          [http.routers.apex]
            rule = "Host(`cloudmason.org`)"
            service = "apex"
            [http.routers.apex.tls]
              certResolver = "myresolver"
              [[http.routers.apex.tls.domains]]
                main = "cloudmason.org"
                sans = ["*.cloudmason.org"]
          [http.routers.awx]
            rule = "Host(`awx.cloudmason.org`)"
            service = "awx"
          [http.routers.web]
            rule = "Host(`web.cloudmason.org`)"
            service = "web"
          [http.routers.nzbget]
            rule = "Host(`nzbget.cloudmason.org`)"
            # middlewares = ["admin-user"]
            service = "nzbget"
            [http.routers.nzbget.tls]
          [http.routers.sonarr]
            rule = "Host(`sonarr.cloudmason.org`)"
            # middlewares = ["admin-user"]
            service = "sonarr"
            [http.routers.sonarr.tls]
          [http.routers.radarr]
            rule = "Host(`radarr.cloudmason.org`)"
            # middlewares = ["admin-user"]
            service = "radarr"
            [http.routers.radarr.tls]

        [http.middlewares]
          [http.middlewares.admin-user.basicAuth]
            users = ["admin:{{ traefik.admin.password }}"]

        [http.services]
          [http.services.apex.loadBalancer]
            [[http.services.apex.loadBalancer.servers]]
              url = "http://cloudmason.org:8000/"
          [http.services.awx.loadBalancer]
            [[http.services.awx.loadBalancer.servers]]
              url = "http://192.168.1.221:80/"
          [http.services.web.loadBalancer]
            [[http.services.web.loadBalancer.servers]]
              url = "http://web.cloudmason.org:8000/"
          [http.services.nzbget.loadBalancer]
            [[http.services.nzbget.loadBalancer.servers]]
              url = "http://qnap.cloudmason.org:11000/"
          [http.services.sonarr.loadBalancer]
            [[http.services.sonarr.loadBalancer.servers]]
              url = "http://qnap.cloudmason.org:11001/"
          [http.services.radarr.loadBalancer]
            [[http.services.radarr.loadBalancer.servers]]
              url = "http://qnap.cloudmason.org:11002/"

      # [[tls.certificates]]
      #   certFile = "/home/traefik/cloudmason.org.crt"
      #   keyFile = "/home/traefik/cloudmason.org.key"

      # [tls.stores]
      #   [tls.stores.default]
      #     [tls.stores.default.defaultCertificate]
      #       certFile = "/home/traefik/cloudmason.org.crt"
      #       keyFile = "/home/traefik/cloudmason.org.key"
      [tls.options]
        [tls.options.default]
          minVersion = "VersionTLS12"
        [tls.options.mintls13]
          minVersion = "VersionTLS13"
  notify: Restart traefik
  become: yes

- name: Deploy cloudmason.org.crt
  copy:
    dest: /home/traefik/cloudmason.org.crt
    owner: traefik
    group: traefik
    mode: 0644
    content: |
      -----BEGIN CERTIFICATE-----
      MIIFUzCCBDugAwIBAgISA4qdIRjlhfWVaIR+e+a622G7MA0GCSqGSIb3DQEBCwUA
      MEoxCzAJBgNVBAYTAlVTMRYwFAYDVQQKEw1MZXQncyBFbmNyeXB0MSMwIQYDVQQD
      ExpMZXQncyBFbmNyeXB0IEF1dGhvcml0eSBYMzAeFw0yMDEwMjEwMjI4MTZaFw0y
      MTAxMTkwMjI4MTZaMBkxFzAVBgNVBAMTDmNsb3VkbWFzb24ub3JnMIIBIjANBgkq
      hkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAohPMXHgBFdDIpSXPS0fKmNwNafS7VJZm
      hu91/y3J9YzrYSUiwNI8expnDbvAGY7oao8RBknarOmj9fBxjEHKlkz6+FaEhBeA
      ykzeNkZzRIgP9lcECtGW04mSzB8FdJgOBxYtvRbySgbDSTE8nH2pOnMGzPf/+JfH
      ri1UNXA3P5T8clzbczU7b7xOkrBltiTPpc/ycx6fg+9Epku/cNQHdZ3Kpzn/wzSR
      5NGV//eWyrtS5faJK0KJGPn5E17FJlSjpjmA/zseO6KcBxlMX+zP+Pkwidmj928+
      MMaFJuT1HDD3+CcGv0EJi54gxfyBVKR9Qi8iiKx4rhdS2SX+tgObuwIDAQABo4IC
      YjCCAl4wDgYDVR0PAQH/BAQDAgWgMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEF
      BQcDAjAMBgNVHRMBAf8EAjAAMB0GA1UdDgQWBBT+4k1Zu1+vglBysj2jkRXIDspa
      4zAfBgNVHSMEGDAWgBSoSmpjBH3duubRObemRWXv86jsoTBvBggrBgEFBQcBAQRj
      MGEwLgYIKwYBBQUHMAGGImh0dHA6Ly9vY3NwLmludC14My5sZXRzZW5jcnlwdC5v
      cmcwLwYIKwYBBQUHMAKGI2h0dHA6Ly9jZXJ0LmludC14My5sZXRzZW5jcnlwdC5v
      cmcvMBkGA1UdEQQSMBCCDmNsb3VkbWFzb24ub3JnMEwGA1UdIARFMEMwCAYGZ4EM
      AQIBMDcGCysGAQQBgt8TAQEBMCgwJgYIKwYBBQUHAgEWGmh0dHA6Ly9jcHMubGV0
      c2VuY3J5cHQub3JnMIIBAwYKKwYBBAHWeQIEAgSB9ASB8QDvAHUAXNxDkv7mq0VE
      sV6a1FbmEDf71fpH3KFzlLJe5vbHDsoAAAF1STNAaAAABAMARjBEAiAp6vxB4zP2
      OH4+s40OoQEI9w2LQFXwpRSUieNBhHStiAIgHaqzPo3t3PnckWo+VFrY0hzvKldu
      asnp+LQUZal8rikAdgD2XJQv0XcwIhRUGAgwlFaO400TGTO/3wwvIAvMTvFk4wAA
      AXVJM0KAAAAEAwBHMEUCICueY/n4BVkKTYIIAgaV9oxim+hDhStuqtyv9Xy0C9GT
      AiEA9ZvZjlDFZjJKBOofrr8Xg2B7vGE6qEE8Kae4sMlkO+owDQYJKoZIhvcNAQEL
      BQADggEBAGMy+ZfwD+BsE28YnmA2Oke8y7sExUlq3reMnfEuSH2/9tI0Rjjan2W5
      Ez1BTAQ0HZG4EoxTreXvHNz9PNhX5QBG/tm+sBoZ9Xxxj3eidXN6qOEIDByhAAHH
      N0+fh6BZegZ0IxTizNB+pu9XYNosDovi7+UX8IDaZCyusSz4F9hX/91wZpXrDLLg
      bF4Rp0/L2wAolHGT/vyQIPvXkcAr1aCPquMRMz/cK7+aV+Ellzt3BVPljlUfrE8p
      dN+0zHOwgAHGqH56Pm5fQzRvrQ3LsDwC4nrT8lpkqm5qKQqENopx9cM02PngVzLv
      026pTVmy6D2Kf/DLXirKQXSHxLlA+NM=
      -----END CERTIFICATE-----
      -----BEGIN CERTIFICATE-----
      MIIEkjCCA3qgAwIBAgIQCgFBQgAAAVOFc2oLheynCDANBgkqhkiG9w0BAQsFADA/
      MSQwIgYDVQQKExtEaWdpdGFsIFNpZ25hdHVyZSBUcnVzdCBDby4xFzAVBgNVBAMT
      DkRTVCBSb290IENBIFgzMB4XDTE2MDMxNzE2NDA0NloXDTIxMDMxNzE2NDA0Nlow
      SjELMAkGA1UEBhMCVVMxFjAUBgNVBAoTDUxldCdzIEVuY3J5cHQxIzAhBgNVBAMT
      GkxldCdzIEVuY3J5cHQgQXV0aG9yaXR5IFgzMIIBIjANBgkqhkiG9w0BAQEFAAOC
      AQ8AMIIBCgKCAQEAnNMM8FrlLke3cl03g7NoYzDq1zUmGSXhvb418XCSL7e4S0EF
      q6meNQhY7LEqxGiHC6PjdeTm86dicbp5gWAf15Gan/PQeGdxyGkOlZHP/uaZ6WA8
      SMx+yk13EiSdRxta67nsHjcAHJyse6cF6s5K671B5TaYucv9bTyWaN8jKkKQDIZ0
      Z8h/pZq4UmEUEz9l6YKHy9v6Dlb2honzhT+Xhq+w3Brvaw2VFn3EK6BlspkENnWA
      a6xK8xuQSXgvopZPKiAlKQTGdMDQMc2PMTiVFrqoM7hD8bEfwzB/onkxEz0tNvjj
      /PIzark5McWvxI0NHWQWM6r6hCm21AvA2H3DkwIDAQABo4IBfTCCAXkwEgYDVR0T
      AQH/BAgwBgEB/wIBADAOBgNVHQ8BAf8EBAMCAYYwfwYIKwYBBQUHAQEEczBxMDIG
      CCsGAQUFBzABhiZodHRwOi8vaXNyZy50cnVzdGlkLm9jc3AuaWRlbnRydXN0LmNv
      bTA7BggrBgEFBQcwAoYvaHR0cDovL2FwcHMuaWRlbnRydXN0LmNvbS9yb290cy9k
      c3Ryb290Y2F4My5wN2MwHwYDVR0jBBgwFoAUxKexpHsscfrb4UuQdf/EFWCFiRAw
      VAYDVR0gBE0wSzAIBgZngQwBAgEwPwYLKwYBBAGC3xMBAQEwMDAuBggrBgEFBQcC
      ARYiaHR0cDovL2Nwcy5yb290LXgxLmxldHNlbmNyeXB0Lm9yZzA8BgNVHR8ENTAz
      MDGgL6AthitodHRwOi8vY3JsLmlkZW50cnVzdC5jb20vRFNUUk9PVENBWDNDUkwu
      Y3JsMB0GA1UdDgQWBBSoSmpjBH3duubRObemRWXv86jsoTANBgkqhkiG9w0BAQsF
      AAOCAQEA3TPXEfNjWDjdGBX7CVW+dla5cEilaUcne8IkCJLxWh9KEik3JHRRHGJo
      uM2VcGfl96S8TihRzZvoroed6ti6WqEBmtzw3Wodatg+VyOeph4EYpr/1wXKtx8/
      wApIvJSwtmVi4MFU5aMqrSDE6ea73Mj2tcMyo5jMd6jmeWUHK8so/joWUoHOUgwu
      X4Po1QYz+3dszkDqMp4fklxBwXRsW10KXzPMTZ+sOPAveyxindmjkW8lGy+QsRlG
      PfZ+G6Z6h7mjem0Y+iWlkYcV4PIWL1iwBi8saCbGS5jN2p8M+X+Q7UNKEkROb3N6
      KOqkqm57TH2H3eDJAkSnh6/DNFu0Qg==
      -----END CERTIFICATE-----
  become: yes

- name: Deploy cloudmason.org.key
  copy:
    dest: /home/traefik/cloudmason.org.key
    owner: traefik
    group: traefik
    mode: 0600
    content: |
      $ANSIBLE_VAULT;1.1;AES256
      66323362346366373933346133313961323265313161346431353432393638313462316138643564
      3863396132336231303836373333346437383462623464360a646334633864666165663836363639
      66303364613037303263646465613737343535346162393165616633666233613064333237643832
      3438393565343732320a613265636338326661636630653037373536303366653230613632623531
      34346431303331363435393437633666613130613033333763666132386161353531323161336338
      62386131313766623537363432363739373064323962346335326462363561343039363338386630
      30623463643936643631393263336235636262356637626664333530343637326632643737636430
      61626137303336386462333133353037366233383138383136373830616361653061643837346337
      35343434336361653766303663343463396263313061323836343534363666623139333262653565
      65663134623861633932363866333730303030373038373364626264366332666436626236343737
      38363135656663373361333434326464333530393233363537333531626130646630333532633231
      63653663343935323935343461306664316135383263396133383161386563393762336339326631
      33376163653633613339336533353031616433353461383739383062366132333437613333333232
      65633330386161376238366564343733303538616162653161306534363337633361623664663935
      34376364356531373266303664623439383935643439383034643133626563633433306531313030
      36326664666632383739303239373462343763646531333965303531313230353539383734313238
      65306461323337646136346333663935313731343330623262363562373565336363626635646636
      62303463646236326466306334393231376263363361303135646366393738393865666262636136
      36653163656235633466346237653464343865333664303832306563343636653533366439656666
      31626336626135323362623562326336353230303961303132383939326161616133303935656163
      33616265626134666239383736376366623461393237656339616331346462663736626131663662
      66373865636363333837323932326639326666653532333436343766653131613066376463323263
      39663966313639623031313265633739656165343865393433613232616233393130363464613230
      61306665643337383637353430306236653165636238353039313663643562626539613664326636
      64303765626464346237316437363662323937366630366637316634363332316430316339646265
      62656366383035653534323266356564336438366139356661636236363838626438613430383034
      65613338626432633537343266326163343835346564623533656261376162383465373034303138
      39626436633235656430623434343135626332313465393931306231613136616562383735363863
      65346434336330383630373733313937333837386637363634346536306532643035376538323332
      61346330616164613234393230353261666634363162643234653434636162323334363165633837
      39383237643238303163386463356438313366396139643661316238326161353963653564313566
      66633132313962656664316131643532383362366137373064646531353165353430353630383435
      33346166643663623636306461306466633939323335626137303030353861376336323732333332
      39383436616163313764643766616138643365643166666134663762643739393733333364396530
      38656162663830663935323934396638373133303961633730613533653966353665306561613638
      61613635386436383263633063383162626366653330646461393266633834343231333165396633
      30313931393062373166626439353535636631623464623164616430626239626463363361636439
      32303030396239396662303836666635623661366666663638303966656561643433636530383933
      30663336653763306433313564616133363134633735386361393566303364313864363132626265
      30326666313032656438643639626462616337373230613132383335623732336138303764336339
      39656661373366373033636130326432316334633864643637313932663832373435636332386533
      33623761373233653962663636383837396162653135366637376533653335333939373361316530
      32613030656237636533386231613038353734346330323161643138326561616535363533653037
      37356230373662626264383563373839316437663230323430323366633635373133626335376130
      66626539626435656663666365346538636564393830663763303438643137303262326463656161
      32643561633265346266386532663265663261303835303734396265613234393361343434633263
      63623231313664303530656130363335333631636633626134353030623634336534646532383262
      31653138336264323932343731613066363834383939376565386661646131353230306362636431
      65393865313030623363393735396166616562393030303632356536396531383437313063383862
      34326666303139623662353638656262613636363433393366653133363734663166656466343033
      34633432653436646332373937303738346638643763353763633166616239666666323638646233
      38633030353732313262396466323435336434323363633536373734346663373930386664656564
      37343966646265613032386337643939653139303265383264343533616364666164366232633634
      32306561636439393538386365353466626236646138313566303137343236333433396238306231
      39333334373961336237323262626465663038316235363436373263636262646631353631373639
      35643237626434306538303539333537653231626665636234386238623930613936363934373534
      63346136396339633062393230666530643164643738323635613564343466373033323964303762
      35636664613965613062383230323936343563343166346634663933343037376362363439303634
      34346262303136316562386330353034326431643765393732633637653565363834313437643936
      61373638313034643562326539636361666137653033303733323963346362353763383235326433
      62316134613736343931323738303533636434633763656263346232323465623039623861306336
      32373466373236633838333034623536363433643831333534356365623435626666326132326237
      65633665636237303736366338633530383361633862313063386338366263373439333430353463
      37366230393933663931343737303738613962366665363963383266643231613766626336656238
      64336237623136366535303161326430316164333333323430623431346162336161663833323566
      63303131356630306133366430626237316336313031396430646437313139643462343235333265
      61643362373437656561313530656465646530336231396637663637303666613862323831326139
      61303363346235343935316466386434313635653064383865366530353563336333386364366239
      39376132396666366336323864613432663439336563363739396166643161393930303163303736
      66366165663232363663313738383431626239383332356138653939336438353266343030383366
      31376431326430623837383230393731373362663137646261326264626535623563323065393633
      34366534316163326163313638353964393332333835643837333938313531626664313835643964
      33353834326436663861366334363463316334353665313534336234353238643762383839393833
      35656431616461343165303833386361386530343239383535393739306539616566313939636236
      61363532343236626333366630616566613837636539343162333362383861373035633035643365
      62366535383965656637613636306638336232656561303839663139323564313030316239313565
      30336366333763616538396461396665633539383331333939316639613366333763613161613433
      37643364363564303063306564623333346538643634623761303065393064323735363932643263
      37376466383266383838326265613238643532653439313762336366663734656234656332663662
      30626635356166343839636533653236366231643131306362336431323537346436663932626366
      38373939373963323638633233366365646162333063326166636136353638653962633737303862
      36363064336362326232326138366139323464353762336661656133613161376432666163373831
      31333963663532303630373230313931316332626334663931343736386231306337363334356665
      63376265646535363761663135663535323961306365386230356134646464323838666232316433
      38353033366431343034646537373666366232396635633630636466666333376364323064626333
      39396134643739623939393266613264323763653332623032636330376132343732633638663932
      32343031306637663263323964633861363430616634636362303031633832346538343435663366
      38633139353163366330653030383963333963623132363139613337613037393630363062626538
      31653937653063663064633637376234623934356664373134653432353663643533
  become: yes

- name: Give net priv ports to the traefik binary
  shell: setcap 'cap_net_bind_service=+ep' /home/traefik/traefik
  become: yes

- name: Deploy the traefik systemd unit file
  copy:
    dest: /etc/systemd/system/traefik.service
    owner: root
    group: root
    mode: 0644
    content: |
      [Unit]
      Description=Traefik
      Documentation=https://doc.traefik.io/traefik/

      [Service]
      User=traefik
      AmbientCapabilities=CAP_NET_BIND_SERVICE
      Type=notify
      Environment=CF_DNS_API_TOKEN={{ traefik.cloudflare.api_key }}
      ExecStart=/home/traefik/traefik --configFile=/home/traefik/traefik.toml
      Restart=always
      WatchdogSec=1s

      [Install]
      WantedBy=multi-user.target
  become: yes

- name: Start and enable traefik
  systemd:
    name: traefik
    state: started
    enabled: yes
    daemon_reload: yes
  become: yes
